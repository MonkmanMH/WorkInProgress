---
title: "Smoke gets in your eyes"
author: "Martin Monkman"
date: "August 23, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = "figures/")
```


```{r packages, warning=FALSE, message=FALSE}

# tidyverse
library(tidyverse)
library(glue)

```



## Air quality

As I write this (2018-08-23) there are [currently 469 wildfires burning in British Columbia](http://bcfireinfo.for.gov.bc.ca/hprScripts/WildfireNews/Fires.asp?Mode=normal&AllFires=0&FC=0), the largest of which, the Alkali Lake fire, started as four separate fires that have now merged and burned nearly 120,000 hectares (460 square miles). These fires have a significant impact on people's lives--many areas are under evacuation order and evacuation alert, and there are reports that homes have been destroyed by the blazes.

The fires also create a significant amount of smoke which has been pushed great distances by the shifting winds. This includes the large population centres of Vancouver and Victoria in British Columbia, as well as the Seattle metropolitan region and elsewhere in Washington. (Clifford Mass, Professor of Atmospheric Sciences at the Universtiy of Washington in Seattle, has written extensively about the smoke events in the region; see for example [Western Washington Smoke: Darkest Before the Dawn](http://cliffmass.blogspot.com/2018/08/western-washington-smoke-darkest-before.html) from 2018-08-22.)

The Province of British Columbia has many air quality monitoring stations around the province, and makes the data available. The measure most used for monitoring the effects on health is PM25 or PM2.5, for fine particles with a diameter of 2.5 microns (millionths of a metre). The B.C. government has a [Current Particulate Matter map](http://www.env.gov.bc.ca/epd/bcairquality/readings/find-stations-map-PM25.html) that colour codes the one hour average measures for all the testing stations around the province.



### The data file

The DataBC Catalogue provides access to air quality data. There's ["verified" to the end of 2017](https://catalogue.data.gov.bc.ca/dataset/air-quality-monitoring-verified-hourly-data), and ["unverified" for the past 30 days](https://catalogue.data.gov.bc.ca/dataset/air-quality-monitoring-unverified-hourly-air-quality-and-meteorological-data). Since we want to see what happened this week, it's the latter we want. (The page with the [links to the raw files is here](ftp://ftp.env.gov.bc.ca/pub/outgoing/AIR/Hourly_Raw_Air_Data/Air_Quality/).)

The files are arranged by particulate or gas type; there's a table for ozone and another for sulpher dioxide, and others for the particulate matter. 

Note that the data are made available under the Province of B.C.'s Open Data license, and are in nice tidy form. And the date format is [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601), which makes me happy.

To make sure we've got a reproducible version, I've saved the file I downloaded early this morning to my google drive. The link to the folder is [here](https://drive.google.com/drive/folders/1zxhz9niF5ooLHw-_JCylCyRVbH8wPkfK?usp=sharing).


```{r results='hide', message=FALSE}

PM25_data <- readr::read_csv("PM25_2018-08-23.csv")


```


For the first plot, let's look at the PM2.5 level for my hometown of Victoria, B.C.

```{r Victoria}

PM25_data %>%
  filter(STATION_NAME == "Victoria Topaz") %>%
  ggplot() +
  geom_line(aes(x = DATE_PST, y = REPORTED_VALUE)) +
  labs(x = "date",
       title = glue("Air quality: Victoria Topaz"),
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: B.C. Ministry of Environment and Climate Change Strategy")
  

```


There are 61 air quality monitoring stations around British Columbia. It would be interesting to see how the air quality was in other parts of the region--and since over half (54% in 2017) of the province's population lives in the Vancouver Census Metropolitan Area (CMA), let's plot the air quality there. There are multiple stations in the Vancouver CMA, so I chose the one at New Westminster Sapperton Park...it's fairly central in the region.

We can run this line of code to see a listing of all 61 stations (but we won't do that now...)

```{r eval=FALSE}
# list all the air quality stations for which there is PM2.5 data
unique(PM25_data$STATION_NAME)

```


And since we're going to be doing this often, let's wrap the code that filters for the location we want and runs the plot in a function. Note that we'll create a new variable `station_name` so all we need to do to change the plot is assign the name of the station we want, and off we go. Not only does this simplify our lives now, but is all-but-essential for a Shiny application.



```{r plot_function}


# the air quality plot
PM25_plot <- function(datafile, station_name){
  datafile %>%
  filter(STATION_NAME == station_name) %>%
  ggplot() +
  geom_line(aes(x = DATE_PST, y = REPORTED_VALUE)) +
  labs(x = "date",
       title = glue("Air quality: ", station_name),
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: B.C. Ministry of Environment and Climate Change Strategy")
}

```


```{r NewWestminster}

# our New Westminster plot
station_name <- "New Westminster Sapperton Park"

PM25_plot(PM25_data, station_name)

```


And what about the towns that are the closest to the fires? While there are fires burning across the province, the fires that are burning the forests of the Nechako Plateau have understandably received a lot of attention. You may have seen the news stories and images from Prince George like [this](https://globalnews.ca/news/4393740/prince-george-wildfire-smoke/) and [this](https://globalnews.ca/news/4395799/fort-st-james-smoke-timelapse/), or the [images of the smoke plume from the NASA Worldview site ](https://worldview.earthdata.nasa.gov/?p=geographic&l=VIIRS_SNPP_CorrectedReflectance_TrueColor(hidden),MODIS_Aqua_CorrectedReflectance_TrueColor(hidden),MODIS_Terra_CorrectedReflectance_TrueColor,Reference_Labels,Reference_Features(hidden),Coastlines&t=2018-08-17-T00%3A00%3A00Z&z=3&v=-129.8449397281824,48.691966947332034,-115.07931472818241,57.067943509832034).

Prince George is east of many major fires, downwind of the prevailing westerly winds. So what has the air quality in Prince George been like?

```{r PrinceGeorge}

station_name <- "Prince George Plaza 400"

PM25_plot(PM25_data, station_name)



```


Or still closer to the fires, the town of Burns Lake.

```{r BurnsLake}

station_name <- "Burns Lake Fire Centre"

PM25_plot(PM25_data, station_name)

```


The town of Smithers is west of the fires that are burning on the Nechako Plateau and producing all the smoke experienced in Burns Lake and Prince George. The residents of Smithers have had a very different experience, only seeing smoke in the sky when the winds shifted to become easterly.


```{r Smithers}

station_name <- "Smithers St Josephs"

PM25_plot(PM25_data, station_name)

```

***

### multiple stations in one plot

You may have noticed that the Y axis on the plots can be quite different--for example, Victoria reaches 300, Smithers gets to 400, and Prince George is double that at 800, and Burns Lake is more than double again. There are two ways we can compare multiple stations: a single plot, or faceted plots.


#### line

```{r four_plot}


station_name <- c("Burns Lake Fire Centre", "Prince George Plaza 400", "Smithers St Josephs", "Victoria Topaz")

PM25_data %>%
  filter(STATION_NAME %in% station_name) %>%
  ggplot() +
  geom_line(aes(x = DATE_PST, y = REPORTED_VALUE, colour = STATION_NAME)) +
  labs(x = "date",
       title = glue("Air quality: Burns Lake, Prince George, Smithers, Victoria"),
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: Ministry of Environment and Climate Change Strategy")



```


#### facets

Facets give us another way to view the comparisons. In the first version, with the facets stacked vertically, it emphasizes comparisons on the X axis--that is, over time. In this way, we can see that that four locations have had a range of intensity of the smoke events, and that those events have occured at different times. 

For this, we'll shorten the period so that is starts with August 1.

```{r facets}


station_name <- c("Burns Lake Fire Centre", "Prince George Plaza 400", "Smithers St Josephs", "Victoria Topaz")


PM25_data %>%
  filter(STATION_NAME %in% station_name,
         DATE_PST >= "2018-08-01") %>%
  ggplot() +
  geom_line(aes(x = DATE_PST, y = REPORTED_VALUE)) +
  facet_grid(STATION_NAME ~ .) +
  labs(x = "date",
       title = glue("Air quality: Burns Lake, Prince George, Smithers, Victoria"),
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: B.C. Ministry of Environment and Climate Change Strategy")


PM25_data %>%
  filter(STATION_NAME %in% station_name,
         DATE_PST >= "2018-08-01") %>%
  ggplot() +
  geom_line(aes(x = DATE_PST, y = REPORTED_VALUE)) +
  facet_grid(. ~ STATION_NAME) +
  labs(x = "date",
       title = glue("Air quality: Burns Lake, Prince George, Smithers, Victoria"),
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: B.C. Ministry of Environment and Climate Change Strategy")


```


These two plots show that Burns Lake and Prince George have not only had the most extreme smoke events, but that they have had sustained periods of poor air quality through the whole month. While the most extreme event in Smithers exceeds that of Victoria, the folks there haven't had a prolonged period of smoke in the air like the other three locations--a "one and done".

-30-