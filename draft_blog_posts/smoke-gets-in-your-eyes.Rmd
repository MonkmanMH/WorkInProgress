---
title: "Smoke gets in your eyes"
author: "Martin Monkman"
date: "August 23, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages}

# tidyverse
library(tidyverse)
library(glue)
library(googledrive)

# alternaverse
library(RCurl)

```



## Air quality

As I write this (2018-08-23) there are [currently 469 wildfires burning in British Columbia](http://bcfireinfo.for.gov.bc.ca/hprScripts/WildfireNews/Fires.asp?Mode=normal&AllFires=0&FC=0), the largest of which, the Alkali Lake fire, started as four separate fires that have now merged and burned nearly 120,000 hectares (460 square miles). These fires have a significant impact on people's lives--many areas are under evacuation order and evacuation alert, and there are reports that homes have been destroyed by the blazes.

The fires also create a significant amount of smoke which has been pushed great distances by the shifting winds. This includes the large population centres of Vancouver and Victoria in British Columbia, as well as the Seattle metropolitan region and elsewhere in Washington. (Clifford Mass, Professor of Atmospheric Sciences at the Universtiy of Washington in Seattle, has written extensively about the smoke events in the region; see for example [Western Washington Smoke: Darkest Before the Dawn](http://cliffmass.blogspot.com/2018/08/western-washington-smoke-darkest-before.html) from 2018-08-22.)

The Province of British Columbia has many air quality monitoring stations around the province, and makes the data available. The measure most used for monitoring the effects on health is PM25 or PM2.5, for fine particles with a diameter of 2.5 microns (millionths of a metre). The B.C. government has a [Current Particulate Matter map](http://www.env.gov.bc.ca/epd/bcairquality/readings/find-stations-map-PM25.html) that colour codes the one hour average measures for all the testing stations around the province.



### The data file

The DataBC Catalogue provides access to air quality data. There's ["verified" to the end of 2017](https://catalogue.data.gov.bc.ca/dataset/air-quality-monitoring-verified-hourly-data), and ["unverified" for the past 30 days](https://catalogue.data.gov.bc.ca/dataset/air-quality-monitoring-unverified-hourly-air-quality-and-meteorological-data). Since we want to see what happened this week, it's the latter we want. (The page with the [links to the raw files is here](ftp://ftp.env.gov.bc.ca/pub/outgoing/AIR/Hourly_Raw_Air_Data/Air_Quality/).)

The files are arranged by particulate or gas type; there's a table for ozone and another for sulpher dioxide, and others for the particulate matter. 

Note that the data are made available under the Province of B.C.'s Open Data license, and are in nice tidy form. And the date format is [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601), which makes me happy.

To make sure we've got a reproducible version, I've saved the file I downloaded early this morning to my google drive. The link to the folder is [here](https://drive.google.com/drive/folders/1zxhz9niF5ooLHw-_JCylCyRVbH8wPkfK?usp=sharing).


```{r}

PM25_data <- readr::read_csv("PM25_2018-08-23.csv")


```


For the first plot, let's look at the PM2.5 level for my hometown of Victoria, B.C.

```{r}

station_name <- "Victoria Topaz"

PM25_data %>%
  filter(STATION_NAME == station_name) %>%
  ggplot() +
  geom_line(aes(x = DATE_PST, y = REPORTED_VALUE)) +
  labs(x = "date",
       title = glue("Air quality: ", station_name),
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: B.C. Ministry of Environment and Climate Change Strategy")
  

```


There's a second air quality monitoring station in the Victoria CMA, at Colwood City Hall. To plot that, all we need to do is change the value assigned to the `station_name` variable.

But since we're going to be doing this often, let's wrap the filter and plot code in a function.


```{r}


PM25_plot <- function(datafile, station_name){
  datafile %>%
  filter(STATION_NAME == station_name) %>%
  ggplot() +
  geom_line(aes(x = DATE_PST, y = REPORTED_VALUE)) +
  labs(x = "date",
       title = glue("Air quality: ", station_name),
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: B.C. Ministry of Environment and Climate Change Strategy")
}


station_name <- "Colwood City Hall"

PM25_plot(PM25_data, station_name)

```


```{r}
unique(PM25_data$STATION_NAME)
```



```{r}

station_name <- "Kamloops Federal Building"

PM25_plot(PM25_data, station_name)



```


And what about the towns that are the closest to the fires? You may have seen the news stories and images from Prince George like [this](https://globalnews.ca/news/4393740/prince-george-wildfire-smoke/) and [this](https://globalnews.ca/news/4395799/fort-st-james-smoke-timelapse/), or the [images of the smoke plume from the NASA Worldview site ](https://worldview.earthdata.nasa.gov/?p=geographic&l=VIIRS_SNPP_CorrectedReflectance_TrueColor(hidden),MODIS_Aqua_CorrectedReflectance_TrueColor(hidden),MODIS_Terra_CorrectedReflectance_TrueColor,Reference_Labels,Reference_Features(hidden),Coastlines&t=2018-08-17-T00%3A00%3A00Z&z=3&v=-129.8449397281824,48.691966947332034,-115.07931472818241,57.067943509832034).



```{r}

station_name <- "Prince George Plaza 400"

PM25_plot(PM25_data, station_name)



```


Or still closer to the fires, the town of Burns Lake.

```{r}

station_name <- "Burns Lake Fire Centre"

PM25_plot(PM25_data, station_name)

```


Interstingly, the town of Smithers is west of the fires that are burning on the Nechako Plateau and producing all the smoke experienced in Burns Lake and Prince George. They've had a very different experience, only seeing smoke in the sky when the winds shifted to become easterly.


```{r}

station_name <- "Smithers St Josephs"

PM25_plot(PM25_data, station_name)

```

***

### multiple stations in one plot

You may have noticed that the Y axis on the plots can be quite different--for example, Victoria reaches 300, Smithers gets to 400, and Prince George is double that at 800, and Burns Lake is more than double again. There are two ways we can compare multiple stations: a single plot, or faceted plots.


#### line

```{r}


station_name <- c("Burns Lake Fire Centre", "Prince George Plaza 400", "Smithers St Josephs", "Victoria Topaz")

PM25_data %>%
  filter(STATION_NAME %in% station_name) %>%
  ggplot() +
  geom_line(aes(x = DATE_PST, y = REPORTED_VALUE, colour = STATION_NAME)) +
  labs(x = "date",
       title = glue("Air quality: Burns Lake, Prince George, Smithers, Victoria"),
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: Ministry of Environment and Climate Change Strategy")



```


#### facets

Facets give us another way to view the comparisons. In the first version, with the facets stacked vertically, it emphasizes comparisons on the X axis--that is, over time. In this way, we can see that that four locations have had a range of intensity of the smoke events, and that those events have occured at different times. 

```{r}


station_name <- c("Burns Lake Fire Centre", "Prince George Plaza 400", "Smithers St Josephs", "Victoria Topaz")


PM25_data %>%
  filter(STATION_NAME %in% station_name,
         DATE_PST >= "2018-08-01") %>%
  ggplot() +
  geom_line(aes(x = DATE_PST, y = REPORTED_VALUE)) +
  facet_grid(STATION_NAME ~ .) +
  labs(x = "date",
       title = glue("Air quality: Burns Lake, Prince George, Smithers, Victoria"),
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: B.C. Ministry of Environment and Climate Change Strategy")


PM25_data %>%
  filter(STATION_NAME %in% station_name,
         DATE_PST >= "2018-08-01") %>%
  ggplot() +
  geom_line(aes(x = DATE_PST, y = REPORTED_VALUE)) +
  facet_grid(. ~ STATION_NAME) +
  labs(x = "date",
       title = glue("Air quality: Burns Lake, Prince George, Smithers, Victoria"),
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: B.C. Ministry of Environment and Climate Change Strategy")


```


***

#### rejected

First of all, we'll download the data from the Victoria Topaz station from the B.C. Air Data Archive, from the British Columbia Ministry of Environment. 

* [data download page for Victoria Topaz station](https://envistaweb.env.gov.bc.ca/StationReportFast.aspx?ST_ID=4)

```{r}

library(tidyverse)
library(readxl)
library(lubridate)
library(glue)

```


The downloaded file is a mess. First of all, although I clicked the "Excel" option for file format, the file thinks it's HTML. So I manually cleaned up the table and have saved a functional CSV version of the hourly file from 2018-06-01 to 2018-08-23, with AVG "Type" selected.

```{r}

airqual_hour <- readr::read_csv("Victoria_Topaz_hourly.csv")

airqual_hour <- airqual_hour %>%
  mutate(date_ymd = mdy(Date))

airqual_hour <- airqual_hour %>%
  mutate(timehr = case_when(
    is.na(Time) ~ "00:00:00",
    TRUE ~ as.character(Time)
  ))



airqual_hour <- airqual_hour %>%
  mutate(datetimehr = glue("{date_ymd} {timehr}"),
         datetimehr_2 = ymd_hms(airqual_hour$datetimehr)
)

ls.str(airqual_hour)



```



```{r}

ggplot(airqual_hour, aes(x = datetimehr_2, y = PM25)) +
  geom_line()

airqual_hour %>%
  filter(date_ymd >= "2018-07-01") %>%
  ggplot() + 
  geom_line(aes(x = datetimehr_2, y = PM25))


airqual_hour %>%
  filter(date_ymd >= "2018-07-01") %>%
  ggplot() + 
  geom_line(aes(x = datetimehr_2, y = PM25)) +
  labs(x = "date",
       title = "Victoria Topaz",
       subtitle = "one hour average, µg/m3 of PM2.5", 
       caption = "data: B.C. Air Data Archive")


```




```{r}

ggplot(airqual_hour, aes(x = date_ymd, y = PM25)) +
  geom_point()


```





***

https://twitter.com/ageara/status/1032643002718543872

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Last night&#39;s Victoria&#39;s smoke roller coaster - (ug/m3 / hour of PPM 2.5) feel lucky to be on this side of the curve. Thoughts with BC interior towns continuing to deal with <a href="https://twitter.com/hashtag/AirQuality?src=hash&amp;ref_src=twsrc%5Etfw">#AirQuality</a> from <a href="https://twitter.com/hashtag/BCWildfire?src=hash&amp;ref_src=twsrc%5Etfw">#BCWildfire</a> . Source: <a href="https://twitter.com/hashtag/opendata?src=hash&amp;ref_src=twsrc%5Etfw">#opendata</a> from  <a href="https://t.co/RAPziqMKE8">https://t.co/RAPziqMKE8</a>  <a href="https://twitter.com/hashtag/yyj?src=hash&amp;ref_src=twsrc%5Etfw">#yyj</a> <a href="https://t.co/DJep5MCmA6">pic.twitter.com/DJep5MCmA6</a></p>&mdash; Greg Lawrance (@ageara) <a href="https://twitter.com/ageara/status/1032643002718543872?ref_src=twsrc%5Etfw">August 23, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>



### References

Current Air Quality Data page for [Victoria Topaz station](http://www.env.gov.bc.ca/epd/bcairquality/readings/map/station.html#E231866), from the British Columbia Ministry of Environment

* BC Air Data Archive [data download page for Victoria Topaz station](https://envistaweb.env.gov.bc.ca/StationReportFast.aspx?ST_ID=4)


**tidyverse**

[readr](https://readr.tidyverse.org)

[readxl](https://readxl.tidyverse.org/)
