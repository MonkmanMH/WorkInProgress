---
title: "Regression models and win expectancy"
output: html_document
---


```{r setup}

library(tidyverse)
library(Lahman)

```

As I write this (2018-07-04) the Seattle Mariners are sitting in second place in the American League West, with a winning percentage of .640 and half a game behind the defending World Series champion Houston Astros. 

The Mariners' relatively small run differential (i.e. how many more runs they have scored than allowed) has been noted all season; 

* at the end of the first month of the season Jake Mailhot (@jakemailhot) at Lookout Landing wrote ["Just how lucky have the Mariners been?"](https://www.lookoutlanding.com/2018/5/1/17308386/mariners-cluster-luck-april-run-differential); 

* on May 25, Sports Illustrated carried an article ["The Mariners Have Been Very Lucky, But They May Also Be Pretty Good"](https://www.si.com/mlb/2018/05/25/seattle-mariners-al-west)

*at the end of May (2018-05-29) John Trupin (@JohnTrupin) on the same site wrote ["The Mariners aren’t the first team built on a run differential-beating bullpen"](https://www.lookoutlanding.com/2018/5/29/17406204/the-mariners-arent-the-first-team-built-on-a-run-differential-beating-bullpen-diaz-colome-nicasio).

The team's success has continued; {fill in the blank}

I've written before about run scoring and prevention (here and here); this time, I will compare the individual team performance in a single season.

This seems like a good time to look at the first and simplest of the measures of "win expectation" that have burbled up in the Sabremetric community over the years; the other approaches may be worthy of consideration for a future post.

For the 2018 season, our data source is [Fangraphs' team dashboard](https://www.fangraphs.com/leaders.aspx?pos=all&stats=bat&lg=all&qual=0&type=8&season=2018&month=0&season1=2018&ind=0&team=0,ts&rost=&age=&filter=&players=0). It takes a bit of flinagalling to get what we want.

And for the earlier seasons, we'll rely on the [`Lahman` package](https://cran.r-project.org/web/packages/Lahman/).


## Pythagorean win ratio


Bill James, the godfather of Sabermetrics, developed the Pythagorean win expectation model ([wikipedia page](https://en.wikipedia.org/wiki/Pythagorean_expectation)). The basic idea is that there is a relationship between the runs a team scores ($RS$) and allows ($RA$), and the proportion of the games that they can be expected to win ($WE$). The equation is expressed thus:

$$ WE = RS^2 / (RS^2 + RA^2)$$



FanGraphs ["BaseRuns" page](https://www.fangraphs.com/depthcharts.aspx?position=BaseRuns)

* [Pythagorean Win-Loss](https://www.fangraphs.com/library/principles/expected-wins-and-losses/)

* [Pythagorean Win-Loss](https://www.fangraphs.com/library/team-record-pythagorean-record-and-base-runs/)

* See also ["BaseRuns" definition](https://www.fangraphs.com/library/features/baseruns/) for alternative measure



#### `ggplot2 3.0.0`

This also seemed like a good time to take [the latest version of `ggplot2` (3.0.0)](https://www.tidyverse.org/articles/2018/07/ggplot2-3-0-0/) for a test run.




### function

```{r}

winexp_fun <- function(RS, RA) {
  winratio <- RS^2 / (RS^2 + RA^2)
}

```


test

```{r}

RS <- 4.43
RA <- 4.18


winexp_fun(RS, RA)

```

## Empirical test

```{r}

data(Teams)

head(Teams)

Teams_sel <- Teams %>%
  filter(yearID > 1961) %>%
  rename(RS = R) %>%
  mutate(winpct = W / G)

Teams_sel <- Teams_sel %>%
  mutate(winpct_Pyth = winexp_fun(RS, RA))


head(Teams_sel)

```


#### plot

Use ggplot2 to look at the relationship between the Pythagorean estimate and the true value.

```{r}

ggplot(data = Teams_sel) +
  geom_point(mapping = aes(x = winpct_Pyth, y = winpct))

```


#### The regression model

```{r}

winexp_mod <- lm(winpct_Pyth ~ winpct, Teams_sel)

print(winexp_mod)

summary(winexp_mod)

```



_interpretation_


#### Residuals

One of the interesting things we can look at is the 



---


### `ggeffects` package

Daniel Lüdecke, 2018-07-04, ["Marginal Effects for Regression Models in R"](https://www.r-bloggers.com/marginal-effects-for-regression-models-in-r-rstats-dataviz/)



